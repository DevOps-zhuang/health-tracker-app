<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Health Tracker</title>
    <style>
        .action-buttons {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }
        .btn {
            display: inline-block;
            padding: 10px 15px;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }
        .btn-info {
            background-color: #5bc0de;
        }
        .btn-import {
            background-color: #28a745;
        }
        .btn-edit {
            background-color: #ffc107;
            color: #000;
        }
        .btn-save {
            background-color: #28a745;
        }
        .btn-cancel {
            background-color: #6c757d;
        }
        .btn-delete {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <h1>Health Tracker</h1>
    
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <div class="alert">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    <div>
        <p>Welcome, {{ user.name }} ({{ user.username }})</p>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-cancel">Logout</a>
    </div>

    <form id="entryForm" action="/add" method="POST" onsubmit="return checkDuplicate()">
        <div class="blood-pressure-group">
            <label>Blood Pressure:</label>
            <div class="bp-inputs">
                <div>
                    <label for="systolic">Systolic:</label>
                    <input type="number" id="systolic" name="systolic" required min="100" max="200">
                </div>
                <div>
                    <label for="diastolic">Diastolic:</label>
                    <input type="number" id="diastolic" name="diastolic" required min="60" max="160">
                </div>
            </div>
        </div>
        
        <label for="heart_rate">Heart Rate:</label>
        <input type="number" id="heart_rate" name="heart_rate" required min="50" max="200">
        
        <label for="timestamp">Date and Time:</label>
        <input type="datetime-local" id="timestamp" name="timestamp">
        
        <label for="tags">Tags:</label>
        <input type="text" id="tags" name="tags">
        
        <button type="submit">Add Entry</button>
    </form>

    <div class="action-buttons">
        <a href="/chart" class="btn btn-info">View Blood Pressure Chart</a>
        <a href="/import" class="btn btn-import">Import Data</a>
    </div>

    <h2>Existing Entries</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Date/Time</th>
                <th>Systolic</th>
                <th>Diastolic</th>
                <th>Heart Rate</th>
                <th>Tags</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in entries %}
                <tr data-entry-id="{{ entry.id }}">
                    <td class="display-mode">{{ entry.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td class="display-mode">{{ entry.systolic }}</td>
                    <td class="display-mode">{{ entry.diastolic }}</td>
                    <td class="display-mode">{{ entry.heart_rate }}</td>
                    <td class="display-mode">{{ entry.tags }}</td>
                    <!-- 编辑模式的输入框，默认隐藏 -->
                    <td class="edit-mode" style="display: none;">
                        <input type="datetime-local" value="{{ entry.timestamp.strftime('%Y-%m-%dT%H:%M') }}" class="editable-field" data-field="timestamp">
                    </td>
                    <td class="edit-mode" style="display: none;">
                        <input type="number" value="{{ entry.systolic }}" min="100" max="200" class="editable-field" data-field="systolic">
                    </td>
                    <td class="edit-mode" style="display: none;">
                        <input type="number" value="{{ entry.diastolic }}" min="60" max="160" class="editable-field" data-field="diastolic">
                    </td>
                    <td class="edit-mode" style="display: none;">
                        <input type="number" value="{{ entry.heart_rate }}" min="50" max="200" class="editable-field" data-field="heart_rate">
                    </td>
                    <td class="edit-mode" style="display: none;">
                        <input type="text" value="{{ entry.tags }}" class="editable-field" data-field="tags">
                    </td>
                    <td>
                        <button onclick="toggleEdit({{ entry.id }})" class="btn btn-edit">编辑</button>
                        <button onclick="saveChanges({{ entry.id }})" class="btn btn-save" style="display: none;">保存</button>
                        <button onclick="cancelEdit({{ entry.id }})" class="btn btn-cancel" style="display: none;">取消</button>
                        <button onclick="deleteEntry({{ entry.id }})" class="btn btn-delete">删除</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
    // Generated by Copilot
    function toggleEdit(entryId) {
        const row = document.querySelector(`tr[data-entry-id="${entryId}"]`);
        const displayFields = row.querySelectorAll('.display-mode');
        const editFields = row.querySelectorAll('.edit-mode');
        const editBtn = row.querySelector('.btn-edit');
        const saveBtn = row.querySelector('.btn-save');
        const cancelBtn = row.querySelector('.btn-cancel');

        displayFields.forEach(field => field.style.display = 'none');
        editFields.forEach(field => field.style.display = 'table-cell');
        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
    }

    function cancelEdit(entryId) {
        const row = document.querySelector(`tr[data-entry-id="${entryId}"]`);
        const displayFields = row.querySelectorAll('.display-mode');
        const editFields = row.querySelectorAll('.edit-mode');
        const editBtn = row.querySelector('.btn-edit');
        const saveBtn = row.querySelector('.btn-save');
        const cancelBtn = row.querySelector('.btn-cancel');

        displayFields.forEach(field => field.style.display = 'table-cell');
        editFields.forEach(field => field.style.display = 'none');
        editBtn.style.display = 'inline-block';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
    }

    // Generated by Copilot
    function saveChanges(entryId) {
        const row = document.querySelector(`tr[data-entry-id="${entryId}"]`);
        const data = {};
        row.querySelectorAll('.editable-field').forEach(input => {
            data[input.dataset.field] = input.value;
        });

        fetch(`/api/update/${entryId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('保存成功！');
                location.reload();
            } else {
                alert(result.message || '保存失败，请重试！');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('保存失败，请检查控制台获取详细信息');
        });
    }

    function deleteEntry(entryId) {
        if (confirm('确定要删除这条记录吗？')) {
            fetch(`/api/delete/${entryId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('删除成功！');
                    location.reload();
                } else {
                    alert(result.message || '删除失败，请重试！');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除失败，请检查控制台获取详细信息');
            });
        }
    }

    function checkDuplicate() {
        const timestamp = document.getElementById('timestamp').value;
        const entries = document.querySelectorAll('tr[data-entry-id]');
        for (let entry of entries) {
            const entryTimestamp = entry.querySelector('.display-mode').innerText;
            if (entryTimestamp === timestamp.replace('T', ' ')) {
                alert('A record with the same date and time already exists.');
                return false;
            }
        }
        return true;
    }
    </script>
</body>
</html>