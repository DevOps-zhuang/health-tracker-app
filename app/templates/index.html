<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Health Tracker</title>
    <style>
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }
        .header-right {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-right: 20px;  /* Add some margin to the right button group */
        }
        .btn {
            display: inline-flex;
            padding: 8px 15px;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: all 0.3s ease;
            white-space: nowrap;
            align-items: center;
        }
        .btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }
        .btn-info { background-color: #5bc0de; }
        .btn-import { background-color: #28a745; }
        .btn-edit { background-color: #ffc107; color: #000; }
        .btn-save { background-color: #28a745; }
        .btn-cancel { background-color: #6c757d; }
        .btn-delete { background-color: #dc3545; }
        
        /* Remove all conflicting styles */
        .header-buttons, .action-buttons {
            display: none !important;
        }
        .welcome {
            margin: 10px 0;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .welcome p {
            margin: 0;
            font-size: 1.2em;
            color: #2c3e50;
            font-weight: 500;
        }
        .welcome p strong {
            color: #007bff;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>Health Tracker</h1>
            <div class="welcome">
                <p>Welcome, <strong>{{ user.username }}</strong></p>
            </div>
        </div>
        <div class="header-right">
            <a href="/chart" class="btn btn-info">View Blood Pressure Chart</a>
            <a href="/import" class="btn btn-import">Import Data</a>
            <a href="{{ url_for('auth.logout') }}" class="btn btn-cancel">Logout</a>
        </div>
    </div>
    
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <div class="alert">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    <form id="entryForm" action="/add" method="POST" onsubmit="return checkDuplicate()">
        <div class="blood-pressure-group">
            <label>Blood Pressure:</label>
            <div class="bp-inputs">
                <div>
                    <label for="systolic">Systolic:</label>
                    <input type="number" id="systolic" name="systolic" required min="100" max="200">
                </div>
                <div>
                    <label for="diastolic">Diastolic:</label>
                    <input type="number" id="diastolic" name="diastolic" required min="60" max="160">
                </div>
            </div>
        </div>
        
        <label for="heart_rate">Heart Rate:</label>
        <input type="number" id="heart_rate" name="heart_rate" required min="50" max="200">
        
        <label for="timestamp">Date and Time:</label>
        <input type="datetime-local" id="timestamp" name="timestamp">
        
        <label for="tags">Tags:</label>
        <input type="text" id="tags" name="tags">
        
        <button type="submit">Add Entry</button>
    </form>

    <h2>Existing Entries</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Date/Time</th>
                <th>Systolic</th>
                <th>Diastolic</th>
                <th>Heart Rate</th>
                <th>Tags</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in entries %}
                <tr data-entry-id="{{ entry.id }}">
                    <td class="display-mode">{{ entry.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td class="display-mode">{{ entry.systolic }}</td>
                    <td class="display-mode">{{ entry.diastolic }}</td>
                    <td class="display-mode">{{ entry.heart_rate }}</td>
                    <td class="display-mode">{{ entry.tags }}</td>
                    <!-- Edit mode input fields, hidden by default -->
                    <td class="edit-mode" style="display: none;">
                        <input type="datetime-local" value="{{ entry.timestamp.strftime('%Y-%m-%dT%H:%M') }}" class="editable-field" data-field="timestamp">
                    </td>
                    <td class="edit-mode" style="display: none;">
                        <input type="number" value="{{ entry.systolic }}" min="100" max="200" class="editable-field" data-field="systolic">
                    </td>
                    <td class="edit-mode" style="display: none;">
                        <input type="number" value="{{ entry.diastolic }}" min="60" max="160" class="editable-field" data-field="diastolic">
                    </td>
                    <td class="edit-mode" style="display: none;">
                        <input type="number" value="{{ entry.heart_rate }}" min="50" max="200" class="editable-field" data-field="heart_rate">
                    </td>
                    <td class="edit-mode" style="display: none;">
                        <input type="text" value="{{ entry.tags }}" class="editable-field" data-field="tags">
                    </td>
                    <td>
                        <button onclick="toggleEdit({{ entry.id }})" class="btn btn-edit">Edit</button>
                        <button onclick="saveChanges({{ entry.id }})" class="btn btn-save" style="display: none;">Save</button>
                        <button onclick="cancelEdit({{ entry.id }})" class="btn btn-cancel" style="display: none;">Cancel</button>
                        <button onclick="deleteEntry({{ entry.id }})" class="btn btn-delete">Delete</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
    // Generated by Copilot
    function toggleEdit(entryId) {
        const row = document.querySelector(`tr[data-entry-id="${entryId}"]`);
        const displayFields = row.querySelectorAll('.display-mode');
        const editFields = row.querySelectorAll('.edit-mode');
        const editBtn = row.querySelector('.btn-edit');
        const saveBtn = row.querySelector('.btn-save');
        const cancelBtn = row.querySelector('.btn-cancel');

        displayFields.forEach(field => field.style.display = 'none');
        editFields.forEach(field => field.style.display = 'table-cell');
        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
    }

    function cancelEdit(entryId) {
        const row = document.querySelector(`tr[data-entry-id="${entryId}"]`);
        const displayFields = row.querySelectorAll('.display-mode');
        const editFields = row.querySelectorAll('.edit-mode');
        const editBtn = row.querySelector('.btn-edit');
        const saveBtn = row.querySelector('.btn-save');
        const cancelBtn = row.querySelector('.btn-cancel');

        displayFields.forEach(field => field.style.display = 'table-cell');
        editFields.forEach(field => field.style.display = 'none');
        editBtn.style.display = 'inline-block';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
    }

    // Generated by Copilot
    function saveChanges(entryId) {
        const row = document.querySelector(`tr[data-entry-id="${entryId}"]`);
        const data = {};
        row.querySelectorAll('.editable-field').forEach(input => {
            data[input.dataset.field] = input.value;
        });

        fetch(`/api/update/${entryId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Saved successfully!');
                location.reload();
            } else {
                alert(result.message || 'Save failed, please try again!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Save failed, please check console for details');
        });
    }

    function deleteEntry(entryId) {
        if (confirm('Are you sure you want to delete this record?')) {
            fetch(`/api/delete/${entryId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Deleted successfully!');
                    location.reload();
                } else {
                    alert(result.message || 'Delete failed, please try again!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Delete failed, please check console for details');
            });
        }
    }

    function checkDuplicate() {
        const timestamp = document.getElementById('timestamp').value;
        const entries = document.querySelectorAll('tr[data-entry-id]');
        for (let entry of entries) {
            const entryTimestamp = entry.querySelector('.display-mode').innerText;
            if (entryTimestamp === timestamp.replace('T', ' ')) {
                alert('A record with the same date and time already exists.');
                return false;
            }
        }
        return true;
    }
    </script>
</body>
</html>